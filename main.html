<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etude - –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>Etude</h1>
                <p>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ–∫–∞–º–∏</p>
            </div>
            <div class="header-right">
                <button onclick="openSettings()" class="secondary-btn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <button onclick="manageClients()" class="secondary-btn">–ö–ª–∏–µ–Ω—Ç—ã</button>
                <button onclick="viewAllChecks()" class="secondary-btn">–í—Å–µ —á–µ–∫–∏</button>
                <button onclick="logout()" class="logout-btn">–í—ã—Ö–æ–¥</button>
            </div>
        </header>
        
        <div class="main-content">
            <div class="welcome-card">
                <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ï–≤–≥–µ–Ω–∏—è –ì—Ä–æ–º–æ–≤–∞</h2>
                <div class="business-info">
                    <p><strong>–ù–æ–º–µ—Ä –ª–∏—Ü–µ–Ω–∑–∏–∏ –±–∏–∑–Ω–µ—Å–∞:</strong> 346776909</p>
                    <p><strong>–¢–µ–ª:</strong> 0534726469</p>
                    <p><strong>–ê–¥—Ä–µ—Å:</strong> –•–∞-–ë–∞–¥–∏–º 4, –†–∏—à–æ–Ω-–ª–µ-–¶–∏–æ–Ω</p>
                </div>
                <button onclick="createNewCheck()" class="primary-btn">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–µ–∫</button>
            </div>
            
            <div class="stats">
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üìã</div>
                        <h4>–í—Å–µ–≥–æ —á–µ–∫–æ–≤</h4>
                        <p id="totalChecks">0</p>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <h4>–û–±—â–∏–π –¥–æ—Ö–æ–¥</h4>
                        <p id="totalRevenue">0 ‚Ç™</p>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìÖ</div>
                        <h4>–ß–µ–∫–∏ –∑–∞ –º–µ—Å—è—Ü</h4>
                        <p id="monthlyChecks">0</p>
                    </div>
                </div>
            </div>

            <div class="recent-checks">
                <div class="section-header">
                    <h3>‚è≥ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —á–µ–∫–∏</h3>
                    <button onclick="viewAllChecks()" class="secondary-btn">–í—Å–µ —á–µ–∫–∏ ‚Üí</button>
                </div>
                <div id="recentChecksList" class="checks-grid"></div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h3>
                <button onclick="closeSettings()" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="githubToken">GitHub API Token:</label>
                    <input type="password" id="githubToken" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à GitHub Token">
                    <small>–¢–æ–∫–µ–Ω –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ GitHub</small>
                </div>
                <div class="form-group">
                    <label for="repoInfo">–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:</label>
                    <input type="text" id="repoInfo" value="2mmisha/etude" readonly>
                </div>
                <div class="form-actions">
                    <button onclick="saveSettings()" class="primary-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button onclick="testConnection()" class="secondary-btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="github-storage.js"></script>
    <script>
        if (!localStorage.getItem('loggedIn')) {
            window.location.href = 'index.html';
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            const savedToken = localStorage.getItem('githubToken');
            if (savedToken) {
                document.getElementById('githubToken').value = savedToken;
                window.githubStorage.token = savedToken;
            }
            loadDashboard();
        });

        function createNewCheck() {
            window.location.href = 'check.html';
        }

        function manageClients() {
            window.location.href = 'clients.html';
        }

        function viewAllChecks() {
            window.location.href = 'all-checks.html';
        }

        function openSettings() {
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function saveSettings() {
            const token = document.getElementById('githubToken').value;
            if (token) {
                localStorage.setItem('githubToken', token);
                window.githubStorage.token = token;
                alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                closeSettings();
            }
        }

        async function testConnection() {
            const token = document.getElementById('githubToken').value;
            if (!token) {
                alert('–í–≤–µ–¥–∏—Ç–µ GitHub Token');
                return;
            }

            try {
                window.githubStorage.token = token;
                const checks = await window.githubStorage.loadChecks();
                alert('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ! –ó–∞–≥—Ä—É–∂–µ–Ω–æ —á–µ–∫–æ–≤: ' + checks.length);
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
            }
        }

        function logout() {
            localStorage.removeItem('loggedIn');
            window.location.href = 'index.html';
        }

        async function loadDashboard() {
            try {
                const checks = await window.githubStorage.loadChecks();
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                document.getElementById('totalChecks').textContent = checks.length;
                
                const totalRevenue = checks.reduce((sum, check) => sum + parseFloat(check.total), 0);
                document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2) + ' ‚Ç™';
                
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const monthlyChecks = checks.filter(check => {
                    const checkDate = new Date(check.date);
                    return checkDate.getMonth() === currentMonth && checkDate.getFullYear() === currentYear;
                }).length;
                document.getElementById('monthlyChecks').textContent = monthlyChecks;

                // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 6 —á–µ–∫–æ–≤
                const recentChecks = checks.slice(-6).reverse();
                const checksList = document.getElementById('recentChecksList');
                
                if (recentChecks.length === 0) {
                    checksList.innerHTML = '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç —á–µ–∫–æ–≤</div>';
                    return;
                }

                checksList.innerHTML = recentChecks.map(check => `
                    <div class="check-card">
                        <div class="check-header">
                            <span class="check-number">#${check.receiptNumber}</span>
                            <span class="check-date">${check.date}</span>
                        </div>
                        <div class="check-customer">${check.customerName}</div>
                        <div class="check-amount">${parseFloat(check.total).toFixed(2)} ‚Ç™</div>
                        <div class="check-actions">
                            <button onclick="viewCheck('${check.receiptNumber}')" class="small-btn">üëÅÔ∏è</button>
                            <button onclick="deleteCheck('${check.receiptNumber}')" class="small-btn delete-btn">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('recentChecksList').innerHTML = 
                    '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
            }
        }

        function viewCheck(receiptNumber) {
            localStorage.setItem('viewCheckNumber', receiptNumber);
            window.open('view-check.html', '_blank');
        }

        async function deleteCheck(receiptNumber) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–µ–∫?')) {
                try {
                    const checks = await window.githubStorage.loadChecks();
                    const updatedChecks = checks.filter(check => check.receiptNumber != receiptNumber);
                    await window.githubStorage.saveChecks(updatedChecks);
                    loadDashboard();
                    alert('–ß–µ–∫ —É–¥–∞–ª–µ–Ω');
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message);
                }
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('settingsModal');
            if (event.target === modal) {
                closeSettings();
            }
        }
    </script>
    <script src="fix-encoding.js"></script>
</body>
</html>
