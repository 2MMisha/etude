<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etude - –í—Å–µ —á–µ–∫–∏</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .filters-card {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .stats-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            text-align: center;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .checks-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .table-header {
            display: grid;
            grid-template-columns: 80px 1fr 120px 100px 120px 100px;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: #2c3e50;
            color: white;
            font-weight: bold;
        }
        
        .table-row {
            display: grid;
            grid-template-columns: 80px 1fr 120px 100px 120px 100px;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #eee;
            align-items: center;
            transition: background-color 0.3s;
        }
        
        .table-row:hover {
            background-color: #f8f9fa;
        }
        
        .table-row:last-child {
            border-bottom: none;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2rem;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .page-info {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .table-header, .table-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
                text-align: center;
            }
            
            .stats-bar {
                grid-template-columns: 1fr;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        
        .export-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>–í—Å–µ —á–µ–∫–∏</h1>
                <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –ø–æ–∏—Å–∫ –ø–æ —á–µ–∫–∞–º</p>
            </div>
            <div class="header-right">
                <button onclick="window.location.href='main.html'" class="secondary-btn">‚Üê –ù–∞–∑–∞–¥</button>
                <button onclick="logout()" class="logout-btn">–í—ã—Ö–æ–¥</button>
            </div>
        </header>

        <div class="filters-card">
            <h3>üîç –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã</h3>
            
            <div class="filters-grid">
                <div class="form-group">
                    <label for="searchQuery">–ü–æ–∏—Å–∫:</label>
                    <input type="text" id="searchQuery" placeholder="–ö–ª–∏–µ–Ω—Ç, –Ω–æ–º–µ—Ä —á–µ–∫–∞...">
                </div>
                <div class="form-group">
                    <label for="dateFrom">–î–∞—Ç–∞ —Å:</label>
                    <input type="date" id="dateFrom">
                </div>
                <div class="form-group">
                    <label for="dateTo">–î–∞—Ç–∞ –ø–æ:</label>
                    <input type="date" id="dateTo">
                </div>
                <div class="form-group">
                    <label for="customerFilter">–ö–ª–∏–µ–Ω—Ç:</label>
                    <select id="customerFilter">
                        <option value="">–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã</option>
                    </select>
                </div>
            </div>
            
            <div class="filters-grid">
                <div class="form-group">
                    <label for="paymentFilter">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</label>
                    <select id="paymentFilter">
                        <option value="">–í—Å–µ —Å–ø–æ—Å–æ–±—ã</option>
                        <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
                        <option value="credit">–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞</option>
                        <option value="check">–ß–µ–∫</option>
                        <option value="transfer">–ü–µ—Ä–µ–≤–æ–¥</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sortBy">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
                    <select id="sortBy">
                        <option value="date-desc">–î–∞—Ç–∞ (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)</option>
                        <option value="date-asc">–î–∞—Ç–∞ (—Å—Ç–∞—Ä—ã–µ —Å–Ω–∞—á–∞–ª–∞)</option>
                        <option value="amount-desc">–°—É–º–º–∞ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)</option>
                        <option value="amount-asc">–°—É–º–º–∞ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button onclick="applyFilters()" class="primary-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    <button onclick="clearFilters()" class="secondary-btn">–°–±—Ä–æ—Å–∏—Ç—å</button>
                    <button onclick="exportToCSV()" class="secondary-btn">üìä –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
                </div>
            </div>
        </div>

        <div class="stats-bar" id="statsBar">
            <!-- Stats will be loaded here -->
        </div>

        <div class="checks-table">
            <div class="table-header">
                <div>‚Ññ</div>
                <div>–ö–ª–∏–µ–Ω—Ç</div>
                <div>–î–∞—Ç–∞</div>
                <div>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</div>
                <div>–°—É–º–º–∞</div>
                <div>–î–µ–π—Å—Ç–≤–∏—è</div>
            </div>
            
            <div id="checksContainer"></div>
        </div>

        <div class="pagination" id="pagination">
            <!-- Pagination will be loaded here -->
        </div>
    </div>

    <script src="github-storage.js"></script>
    <script>
        if (!localStorage.getItem('loggedIn')) {
            window.location.href = 'index.html';
        }

        let currentPage = 1;
        const checksPerPage = 15;
        let allChecks = [];
        let filteredChecks = [];

        const paymentTypes = {
            'cash': 'üíµ –ù–∞–ª–∏—á–Ω—ã–µ',
            'credit': 'üí≥ –ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞',
            'check': 'üìù –ß–µ–∫',
            'transfer': 'üè¶ –ü–µ—Ä–µ–≤–æ–¥'
        };

        document.addEventListener('DOMContentLoaded', async function() {
            await loadAllChecks();
            setupEventListeners();
        });

        async function loadAllChecks() {
            try {
                allChecks = await window.githubStorage.loadChecks();
                allChecks.sort((a, b) => new Date(b.date) - new Date(a.date));
                loadCustomersFilter();
                applyFilters();
            } catch (error) {
                console.error('Error loading checks:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ–∫–æ–≤: ' + error.message);
            }
        }

        function loadCustomersFilter() {
            const customers = [...new Set(allChecks.map(check => check.customerName))].sort();
            const select = document.getElementById('customerFilter');
            
            select.innerHTML = '<option value="">–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer;
                option.textContent = customer;
                select.appendChild(option);
            });
        }

        function setupEventListeners() {
            document.getElementById('searchQuery').addEventListener('input', applyFilters);
            document.getElementById('dateFrom').addEventListener('change', applyFilters);
            document.getElementById('dateTo').addEventListener('change', applyFilters);
            document.getElementById('customerFilter').addEventListener('change', applyFilters);
            document.getElementById('paymentFilter').addEventListener('change', applyFilters);
            document.getElementById('sortBy').addEventListener('change', applyFilters);
        }

        function applyFilters() {
            const searchQuery = document.getElementById('searchQuery').value.toLowerCase();
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const customerFilter = document.getElementById('customerFilter').value;
            const paymentFilter = document.getElementById('paymentFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            filteredChecks = allChecks.filter(check => {
                const matchesSearch = !searchQuery || 
                    check.customerName.toLowerCase().includes(searchQuery) ||
                    check.receiptNumber.toString().includes(searchQuery) ||
                    (check.customerId && check.customerId.toString().includes(searchQuery));
                
                const matchesDate = (!dateFrom || check.date >= dateFrom) && 
                                  (!dateTo || check.date <= dateTo);
                
                const matchesCustomer = !customerFilter || check.customerName === customerFilter;
                const matchesPayment = !paymentFilter || check.paymentType === paymentFilter;

                return matchesSearch && matchesDate && matchesCustomer && matchesPayment;
            });

            // Sorting
            switch (sortBy) {
                case 'date-asc':
                    filteredChecks.sort((a, b) => new Date(a.date) - new Date(b.date));
                    break;
                case 'amount-desc':
                    filteredChecks.sort((a, b) => b.total - a.total);
                    break;
                case 'amount-asc':
                    filteredChecks.sort((a, b) => a.total - b.total);
                    break;
                default: // date-desc
                    filteredChecks.sort((a, b) => new Date(b.date) - new Date(a.date));
            }

            currentPage = 1;
            displayChecks();
            updateStats();
        }

        function clearFilters() {
            document.getElementById('searchQuery').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('customerFilter').value = '';
            document.getElementById('paymentFilter').value = '';
            document.getElementById('sortBy').value = 'date-desc';
            applyFilters();
        }

        function displayChecks() {
            const startIndex = (currentPage - 1) * checksPerPage;
            const endIndex = startIndex + checksPerPage;
            const pageChecks = filteredChecks.slice(startIndex, endIndex);
            const container = document.getElementById('checksContainer');
            
            if (pageChecks.length === 0) {
                container.innerHTML = '<div class="empty-state">–ß–µ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            container.innerHTML = pageChecks.map(check => `
                <div class="table-row">
                    <div class="check-number">#${check.receiptNumber}</div>
                    <div class="check-customer">${check.customerName}</div>
                    <div class="check-date">${check.date}</div>
                    <div class="check-payment">${paymentTypes[check.paymentType] || check.paymentType}</div>
                    <div class="check-amount">${parseFloat(check.total).toFixed(2)} ‚Ç™</div>
                    <div class="check-actions">
                        <button onclick="viewCheck('${check.receiptNumber}')" class="small-btn">üëÅÔ∏è</button>
                        <button onclick="deleteCheck('${check.receiptNumber}')" class="small-btn delete-btn">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');

            setupPagination();
        }

        function setupPagination() {
            const totalPages = Math.ceil(filteredChecks.length / checksPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = `
                    <div class="page-info">
                        –ü–æ–∫–∞–∑–∞–Ω–æ ${filteredChecks.length} –∏–∑ ${allChecks.length} —á–µ–∫–æ–≤
                    </div>
                `;
                return;
            }

            let paginationHTML = `
                <div class="page-info">
                    –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages} | 
                    –ü–æ–∫–∞–∑–∞–Ω–æ ${filteredChecks.length} —á–µ–∫–æ–≤
                </div>
            `;
            
            if (currentPage > 1) {
                paginationHTML += `<button onclick="changePage(${currentPage - 1})" class="secondary-btn">‚Üê –ù–∞–∑–∞–¥</button>`;
            }
            
            // Show page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button class="primary-btn">${i}</button>`;
                } else {
                    paginationHTML += `<button onclick="changePage(${i})" class="secondary-btn">${i}</button>`;
                }
            }
            
            if (currentPage < totalPages) {
                paginationHTML += `<button onclick="changePage(${currentPage + 1})" class="secondary-btn">–í–ø–µ—Ä–µ–¥ ‚Üí</button>`;
            }
            
            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            currentPage = page;
            displayChecks();
            window.scrollTo(0, 0);
        }

        function updateStats() {
            const totalFound = filteredChecks.length;
            const totalAmount = filteredChecks.reduce((sum, check) => sum + parseFloat(check.total), 0);
            const averageCheck = totalFound > 0 ? totalAmount / totalFound : 0;
            const totalVAT = filteredChecks.reduce((sum, check) => sum + parseFloat(check.vat), 0);

            document.getElementById('statsBar').innerHTML = `
                <div class="stat-item">
                    <span class="stat-value">${totalFound}</span>
                    <span class="stat-label">–ù–∞–π–¥–µ–Ω–æ —á–µ–∫–æ–≤</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${totalAmount.toFixed(2)} ‚Ç™</span>
                    <span class="stat-label">–û–±—â–∞—è —Å—É–º–º–∞</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${averageCheck.toFixed(2)} ‚Ç™</span>
                    <span class="stat-label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${totalVAT.toFixed(2)} ‚Ç™</span>
                    <span class="stat-label">–°—É–º–º–∞ –ù–î–°</span>
                </div>
            `;
        }

        function viewCheck(receiptNumber) {
            localStorage.setItem('viewCheckNumber', receiptNumber);
            window.open('view-check.html', '_blank');
        }

        async function deleteCheck(receiptNumber) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–µ–∫?')) {
                try {
                    const checks = await window.githubStorage.loadChecks();
                    const updatedChecks = checks.filter(check => check.receiptNumber != receiptNumber);
                    await window.githubStorage.saveChecks(updatedChecks);
                    await loadAllChecks();
                    alert('–ß–µ–∫ —É–¥–∞–ª–µ–Ω');
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message);
                }
            }
        }

        function exportToCSV() {
            if (filteredChecks.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }

            const headers = ['–ù–æ–º–µ—Ä', '–î–∞—Ç–∞', '–ö–ª–∏–µ–Ω—Ç', '–ù–∞–ª–æ–≥–æ–≤—ã–π –Ω–æ–º–µ—Ä', '–°—É–º–º–∞', '–ù–î–°', '–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã'];
            const csvData = filteredChecks.map(check => [
                check.receiptNumber,
                check.date,
                `"${check.customerName}"`,
                check.customerId || '',
                check.total,
                check.vat,
                paymentTypes[check.paymentType] || check.paymentType
            ]);

            const csvContent = [headers, ...csvData]
                .map(row => row.join(','))
                .join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `—á–µ–∫–∏_etude_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function logout() {
            localStorage.removeItem('loggedIn');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
