<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etude - יצירת קבלה</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>יצירת קבלה חדשה</h1>
            <div>
                <button onclick="window.location.href='main.html'" class="secondary-btn">חזור</button>
                <button onclick="logout()" class="logout-btn">יציאה</button>
            </div>
        </header>

        <div class="check-form">
            <form id="checkForm">
                <div class="form-section">
                    <h3>פרטי העסק</h3>
                    <div class="business-info">
                        <p><strong>Etude</strong></p>
                        <p>יבגניה גרומובה</p>
                        <p>הבה״דים 4, ראשל״צ</p>
                        <p>נייד: 0534726469</p>
                        <p>עסק מורשה: 346776909</p>
                        <p>חשבונית/קבלה מס׳: <span id="receiptNumber">1</span></p>
                    </div>
                </div>

                <div class="form-section">
                    <h3>פרטי הלקוח</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerName">לכבוד (שם הלקוח):</label>
                            <input type="text" id="customerName" required>
                        </div>
                        <div class="form-group">
                            <label for="customerId">ח.פ./ע.מ:</label>
                            <input type="text" id="customerId">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerAddress">כתובת:</label>
                            <input type="text" id="customerAddress">
                        </div>
                        <div class="form-group">
                            <label for="customerPhone">טלפון:</label>
                            <input type="tel" id="customerPhone">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>פרטי השירות/מוצר</h3>
                    <div id="itemsContainer">
                        <div class="item-row">
                            <input type="text" placeholder="פרטים" class="item-details">
                            <input type="number" placeholder="סכום" class="item-amount" step="0.01">
                            <input type="number" placeholder="כמות" class="item-quantity" value="1">
                            <button type="button" onclick="removeItem(this)" class="remove-btn">×</button>
                        </div>
                    </div>
                    <button type="button" onclick="addItem()" class="add-btn">+ הוסף שורה</button>
                </div>

                <div class="form-section">
                    <h3>סיכום</h3>
                    <div class="summary">
                        <p>סה״כ לפני מע״מ: <span id="subtotal">0.00</span> ₪</p>
                        <p>מע״מ (17%): <span id="vat">0.00</span> ₪</p>
                        <p>סה״כ כולל מע״מ: <span id="total">0.00</span> ₪</p>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="paymentType">סוג תשלום:</label>
                            <select id="paymentType">
                                <option value="cash">מזומן</option>
                                <option value="credit">אשראי</option>
                                <option value="check">צ'ק</option>
                                <option value="transfer">העברה</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="date">תאריך:</label>
                            <input type="date" id="date" required>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" onclick="previewCheck()" class="primary-btn">תצוגה מקדימה</button>
                    <button type="button" onclick="saveCheck()" class="primary-btn">שמור קבלה</button>
                    <button type="button" onclick="printCheck()" class="primary-btn">הדפס</button>
                </div>
            </form>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // בדיקת התחברות
        if (!localStorage.getItem('loggedIn')) {
            window.location.href = 'index.html';
        }

        // טעינת מספר קבלה נוכחי
        document.addEventListener('DOMContentLoaded', function() {
            const currentNumber = localStorage.getItem('currentReceiptNumber') || '1';
            document.getElementById('receiptNumber').textContent = currentNumber;
            document.getElementById('date').valueAsDate = new Date();
            
            // חישוב אוטומטי
            setupCalculations();
        });

        function setupCalculations() {
            const inputs = document.querySelectorAll('.item-amount, .item-quantity');
            inputs.forEach(input => {
                input.addEventListener('input', calculateTotals);
            });
        }

        function calculateTotals() {
            let subtotal = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const amount = parseFloat(row.querySelector('.item-amount').value) || 0;
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                subtotal += amount * quantity;
            });

            const vat = subtotal * 0.18;
            const total = subtotal + vat;

            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('vat').textContent = vat.toFixed(2);
            document.getElementById('total').textContent = total.toFixed(2);
        }

        function addItem() {
            const container = document.getElementById('itemsContainer');
            const newItem = document.createElement('div');
            newItem.className = 'item-row';
            newItem.innerHTML = `
                <input type="text" placeholder="פרטים" class="item-details">
                <input type="number" placeholder="סכום" class="item-amount" step="0.01">
                <input type="number" placeholder="כמות" class="item-quantity" value="1">
                <button type="button" onclick="removeItem(this)" class="remove-btn">×</button>
            `;
            container.appendChild(newItem);
            setupCalculations();
        }

        function removeItem(button) {
            if (document.querySelectorAll('.item-row').length > 1) {
                button.parentElement.remove();
                calculateTotals();
            }
        }

        function saveCheck() {
            const checkData = {
                receiptNumber: document.getElementById('receiptNumber').textContent,
                customerName: document.getElementById('customerName').value,
                customerId: document.getElementById('customerId').value,
                customerAddress: document.getElementById('customerAddress').value,
                customerPhone: document.getElementById('customerPhone').value,
                items: Array.from(document.querySelectorAll('.item-row')).map(row => ({
                    details: row.querySelector('.item-details').value,
                    amount: row.querySelector('.item-amount').value,
                    quantity: row.querySelector('.item-quantity').value
                })),
                subtotal: document.getElementById('subtotal').textContent,
                vat: document.getElementById('vat').textContent,
                total: document.getElementById('total').textContent,
                paymentType: document.getElementById('paymentType').value,
                date: document.getElementById('date').value
            };

            // שמירה ב-localStorage
            const checks = JSON.parse(localStorage.getItem('checks') || '[]');
            checks.push(checkData);
            localStorage.setItem('checks', JSON.stringify(checks));

            // עדכון מספר קבלה
            const nextNumber = parseInt(checkData.receiptNumber) + 1;
            localStorage.setItem('currentReceiptNumber', nextNumber.toString());

            alert('הקבלה נשמרה בהצלחה!');
            window.location.href = 'main.html';
        }

        function previewCheck() {
            // כאן ניתן להוסיף תצוגה מקדימה
            alert('תצוגה מקדימה - ניתן להוסיף פונקציונליות זו בהמשך');
        }

        function printCheck() {
            window.print();
        }

        function logout() {
            localStorage.removeItem('loggedIn');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
