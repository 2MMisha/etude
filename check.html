<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etude - –°–æ–∑–¥–∞–Ω–∏–µ —á–µ–∫–∞</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>–°–æ–∑–¥–∞–Ω–∏–µ —á–µ–∫–∞</h1>
                <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–µ–∫–µ</p>
            </div>
            <div class="header-right">
                <button onclick="window.location.href='main.html'" class="secondary-btn">‚Üê –ù–∞–∑–∞–¥</button>
                <button onclick="logout()" class="logout-btn">–í—ã—Ö–æ–¥</button>
            </div>
        </header>

        <div class="check-form">
            <form id="checkForm">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–∑–Ω–µ—Å–µ -->
                <div class="form-section">
                    <h3>üè¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–∑–Ω–µ—Å–µ</h3>
                    <div class="business-info-card">
                        <p><strong>Etude</strong> - –ï–≤–≥–µ–Ω–∏—è –ì—Ä–æ–º–æ–≤–∞</p>
                        <p>–•–∞-–ë–∞–¥–∏–º 4, –†–∏—à–æ–Ω-–ª–µ-–¶–∏–æ–Ω | –¢–µ–ª: 0534726469</p>
                        <p>–õ–∏—Ü–µ–Ω–∑–∏—è –±–∏–∑–Ω–µ—Å–∞: 346776909</p>
                        <div class="form-group">
                            <label for="receiptNumber">–ù–æ–º–µ—Ä —á–µ–∫–∞:</label>
                            <input type="number" id="receiptNumber" min="1" required>
                        </div>
                    </div>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ -->
                <div class="form-section">
                    <h3>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerSelect">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞:</label>
                            <select id="customerSelect" onchange="fillCustomerData()">
                                <option value="">-- –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç --</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerName">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ *:</label>
                            <input type="text" id="customerName" required placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞">
                        </div>
                        <div class="form-group">
                            <label for="customerId">ID/–ù–∞–ª–æ–≥–æ–≤—ã–π –Ω–æ–º–µ—Ä:</label>
                            <input type="text" id="customerId" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerAddress">–ê–¥—Ä–µ—Å:</label>
                            <input type="text" id="customerAddress" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ">
                        </div>
                        <div class="form-group">
                            <label for="customerPhone">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                            <input type="tel" id="customerPhone" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ">
                        </div>
                    </div>
                    <button type="button" onclick="saveCustomer()" class="secondary-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
                </div>

                <!-- –¢–æ–≤–∞—Ä—ã/—É—Å–ª—É–≥–∏ -->
                <div class="form-section">
                    <h3>üì¶ –¢–æ–≤–∞—Ä—ã –∏ —É—Å–ª—É–≥–∏</h3>
                    <div id="itemsContainer">
                        <div class="item-row">
                            <input type="text" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏/—Ç–æ–≤–∞—Ä–∞" class="item-details" required>
                            <input type="number" placeholder="–¶–µ–Ω–∞" class="item-amount" step="0.01" min="0" required>
                            <input type="number" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" class="item-quantity" value="1" min="1" required>
                            <button type="button" onclick="removeItem(this)" class="remove-btn">√ó</button>
                        </div>
                    </div>
                    <button type="button" onclick="addItem()" class="add-btn">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
                </div>

                <!-- –ò—Ç–æ–≥–∏ -->
                <div class="form-section">
                    <h3>üí∞ –ò—Ç–æ–≥–∏</h3>
                    <div class="summary-card">
                        <div class="summary-row">
                            <span>–°—É–º–º–∞ –¥–æ –ù–î–°:</span>
                            <span id="subtotal">0.00 ‚Ç™</span>
                        </div>
                        <div class="summary-row">
                            <span>–ù–î–° (18%):</span>
                            <span id="vat">0.00 ‚Ç™</span>
                        </div>
                        <div class="summary-row total">
                            <span><strong>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</strong></span>
                            <span id="total"><strong>0.00 ‚Ç™</strong></span>
                        </div>
                    </div>
                </div>

                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="form-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="paymentType">üí≥ –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</label>
                            <select id="paymentType">
                                <option value="cash">üíµ –ù–∞–ª–∏—á–Ω—ã–µ</option>
                                <option value="credit">üí≥ –ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞</option>
                                <option value="check">üìù –ß–µ–∫</option>
                                <option value="transfer">üè¶ –ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="date">üìÖ –î–∞—Ç–∞:</label>
                            <input type="date" id="date" required>
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                <div class="form-actions">
                    <button type="button" onclick="saveCheck()" class="primary-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ–∫</button>
                    <button type="button" onclick="saveCheckAndPrint()" class="primary-btn">üñ®Ô∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—á–∞—Ç—å</button>
                    <button type="button" onclick="previewCheck()" class="secondary-btn">üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
                </div>
            </form>
        </div>
    </div>

    <script src="github-storage.js"></script>
    <script>
        if (!localStorage.getItem('loggedIn')) {
            window.location.href = 'index.html';
        }

        let currentCheckNumber = 1;

        document.addEventListener('DOMContentLoaded', async function() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –Ω–æ–º–µ—Ä —á–µ–∫–∞
            try {
                const checks = await window.githubStorage.loadChecks();
                if (checks.length > 0) {
                    const lastNumber = Math.max(...checks.map(c => parseInt(c.receiptNumber)));
                    currentCheckNumber = lastNumber + 1;
                }
            } catch (error) {
                console.error('Error loading checks:', error);
            }

            document.getElementById('receiptNumber').value = currentCheckNumber;
            document.getElementById('date').valueAsDate = new Date();
            setupCalculations();
            loadCustomers();
        });

        function calculateTotals() {
            let subtotal = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const amount = parseFloat(row.querySelector('.item-amount').value) || 0;
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                subtotal += amount * quantity;
            });

            const vat = subtotal * 0.18;
            const total = subtotal + vat;

            document.getElementById('subtotal').textContent = subtotal.toFixed(2) + ' ‚Ç™';
            document.getElementById('vat').textContent = vat.toFixed(2) + ' ‚Ç™';
            document.getElementById('total').textContent = total.toFixed(2) + ' ‚Ç™';
        }

        function setupCalculations() {
            const inputs = document.querySelectorAll('.item-amount, .item-quantity');
            inputs.forEach(input => {
                input.addEventListener('input', calculateTotals);
            });
            calculateTotals();
        }

        function addItem() {
            const container = document.getElementById('itemsContainer');
            const newItem = document.createElement('div');
            newItem.className = 'item-row';
            newItem.innerHTML = `
                <input type="text" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏/—Ç–æ–≤–∞—Ä–∞" class="item-details">
                <input type="number" placeholder="–¶–µ–Ω–∞" class="item-amount" step="0.01" min="0">
                <input type="number" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" class="item-quantity" value="1" min="1">
                <button type="button" onclick="removeItem(this)" class="remove-btn">√ó</button>
            `;
            container.appendChild(newItem);
            setupCalculations();
        }

        function removeItem(button) {
            if (document.querySelectorAll('.item-row').length > 1) {
                button.parentElement.remove();
                calculateTotals();
            }
        }

        async function loadCustomers() {
            try {
                const customers = await window.githubStorage.loadCustomers();
                const select = document.getElementById('customerSelect');
                
                select.innerHTML = '<option value="">-- –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç --</option>';
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = `${customer.name} ${customer.phone ? '(' + customer.phone + ')' : ''}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        async function fillCustomerData() {
            const select = document.getElementById('customerSelect');
            const customerId = select.value;
            if (!customerId) return;

            try {
                const customers = await window.githubStorage.loadCustomers();
                const customer = customers.find(c => c.id == customerId);
                
                if (customer) {
                    document.getElementById('customerName').value = customer.name;
                    document.getElementById('customerId').value = customer.taxId || '';
                    document.getElementById('customerAddress').value = customer.address || '';
                    document.getElementById('customerPhone').value = customer.phone || '';
                }
            } catch (error) {
                console.error('Error filling customer data:', error);
            }
        }

        async function saveCustomer() {
            const name = document.getElementById('customerName').value;
            const taxId = document.getElementById('customerId').value;
            const address = document.getElementById('customerAddress').value;
            const phone = document.getElementById('customerPhone').value;

            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞');
                return;
            }

            try {
                const customers = await window.githubStorage.loadCustomers();
                const newCustomer = {
                    id: Date.now().toString(),
                    name: name,
                    taxId: taxId,
                    address: address,
                    phone: phone,
                    createdAt: new Date().toISOString()
                };

                customers.push(newCustomer);
                await window.githubStorage.saveCustomers(customers);
                loadCustomers();
                alert('‚úÖ –ö–ª–∏–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞: ' + error.message);
            }
        }

        async function saveCheck(print = false) {
            const checkData = {
                receiptNumber: document.getElementById('receiptNumber').value,
                customerName: document.getElementById('customerName').value,
                customerId: document.getElementById('customerId').value,
                customerAddress: document.getElementById('customerAddress').value,
                customerPhone: document.getElementById('customerPhone').value,
                items: Array.from(document.querySelectorAll('.item-row')).map(row => ({
                    details: row.querySelector('.item-details').value,
                    amount: parseFloat(row.querySelector('.item-amount').value) || 0,
                    quantity: parseFloat(row.querySelector('.item-quantity').value) || 1
                })),
                subtotal: parseFloat(document.getElementById('subtotal').textContent),
                vat: parseFloat(document.getElementById('vat').textContent),
                total: parseFloat(document.getElementById('total').textContent),
                paymentType: document.getElementById('paymentType').value,
                date: document.getElementById('date').value,
                timestamp: new Date().toISOString(),
                businessInfo: {
                    name: "Etude",
                    owner: "–ï–≤–≥–µ–Ω–∏—è –ì—Ä–æ–º–æ–≤–∞",
                    address: "–•–∞-–ë–∞–¥–∏–º 4, –†–∏—à–æ–Ω-–ª–µ-–¶–∏–æ–Ω",
                    phone: "0534726469",
                    taxId: "346776909"
                }
            };

            if (!validateCheck(checkData)) {
                return;
            }

            try {
                const checks = await window.githubStorage.loadChecks();
                checks.push(checkData);
                await window.githubStorage.saveChecks(checks);

                if (print) {
                    previewCheck();
                }

                alert('‚úÖ –ß–µ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                window.location.href = 'main.html';
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ–∫–∞: ' + error.message);
            }
        }

        function saveCheckAndPrint() {
            saveCheck(true);
        }

        function validateCheck(checkData) {
            if (!checkData.customerName.trim()) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞');
                return false;
            }
            
            if (checkData.items.length === 0 || checkData.items.some(item => !item.details.trim())) {
                alert('–í–≤–µ–¥–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ —É—Å–ª—É–≥/—Ç–æ–≤–∞—Ä–æ–≤');
                return false;
            }
            
            if (checkData.total <= 0) {
                alert('–°—É–º–º–∞ —á–µ–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0');
                return false;
            }
            
            return true;
        }

        function previewCheck() {
            localStorage.setItem('previewCheckData', JSON.stringify(getCheckData()));
            window.open('view-check.html', '_blank');
        }

        function getCheckData() {
            return {
                receiptNumber: document.getElementById('receiptNumber').value,
                customerName: document.getElementById('customerName').value,
                customerId: document.getElementById('customerId').value,
                customerAddress: document.getElementById('customerAddress').value,
                customerPhone: document.getElementById('customerPhone').value,
                items: Array.from(document.querySelectorAll('.item-row')).map(row => ({
                    details: row.querySelector('.item-details').value,
                    amount: parseFloat(row.querySelector('.item-amount').value) || 0,
                    quantity: parseFloat(row.querySelector('.item-quantity').value) || 1
                })),
                subtotal: parseFloat(document.getElementById('subtotal').textContent),
                vat: parseFloat(document.getElementById('vat').textContent),
                total: parseFloat(document.getElementById('total').textContent),
                paymentType: document.getElementById('paymentType').value,
                date: document.getElementById('date').value
            };
        }

        function logout() {
            localStorage.removeItem('loggedIn');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
